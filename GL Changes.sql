
/*
 * 
 * @Purpose: One-Time use script to correct GL Account Indexes from CRG GL Changer not updating
 *           Project Costing Distributions.
 *
 * @Last Modified: July 27, 2021
 *
**/

-- DROP TABLE ACTFIX2021

CREATE TABLE ACTFIX2021
(OLDACTINDX INT,
 OLDACCT char(129),
 NEWACCT char(129),
 NEWACTINDX INT
);

INSERT INTO ACTFIX2021(OLDACTINDX,OLDACCT,NEWACCT,NEWACTINDX)
VALUES
('3387','1-60-20-235-19050','1-40-34-235-19050','4210'),
('3207','1-30-15-060-19050','1-70-15-060-19050','4173'),
('391','2-40-32-305-21000','2-30-32-305-21000','4279'),
('405','2-40-32-305-29000','2-30-32-305-29000','4288'),
('3406','2-60-20-235-29000','2-40-34-235-29000','4329'),
('3737','2-50-40-520-29000','2-50-42-520-29000','4300'),
('3726','2-50-40-525-20020','2-50-42-525-20020','4302'),
('3727','2-50-40-525-21360','2-50-42-525-21360','4303'),
('3730','2-50-40-525-26530','2-50-42-525-26530','4304'),
('3728','2-50-40-525-29000','2-50-42-525-29000','4306'),
('3729','2-50-40-525-29050','2-50-42-525-29050','4307'),
('3363','2-30-12-180-21260','2-70-12-180-21260','4227'),
('408','2-30-12-180-21300','2-70-12-180-21300','4228'),
('410','2-30-12-180-21600','2-70-12-180-21600','4231'),
('3366','2-30-12-180-21612','2-70-12-180-21612','4232'),
('411','2-30-12-180-26590','2-70-12-180-26590','4235'),
('412','2-30-12-180-28500','2-70-12-180-28500','4238'),
('3052','2-30-12-180-29000','2-70-12-180-29000','4239'),
('2379','2-30-15-060-21290','2-70-15-060-21290','4250'),
('2380','2-30-15-060-21390','2-70-15-060-21390','4251'),
('2489','2-30-15-060-21600','2-70-15-060-21600','4254'),
('2972','2-30-15-060-29000','2-70-15-060-29000','4261'),
('3760','2-30-11-055-29000','2-70-18-055-29000','4220'),
('1724','2-40-31-300-29000','2-20-02-300-29000','4454'),
('3748','6-50-40-525-61360','6-50-42-525-61360','4347'),
('3750','6-50-40-525-66400','6-50-42-525-66400','4349'),
('3457','6-30-12-180-66310','6-70-12-180-66310','4342'),
('3073','6-30-12-180-66320','6-70-12-180-66320','4343'),
('1263','6-30-12-180-66325','6-70-12-180-66325','4344'),
('451','2-60-21-210-20250','2-60-21-210-26595','4438'),
('1865','2-60-21-215-20250','2-60-21-215-26595','4439'),
('1866','2-60-21-220-20250','2-60-21-220-26595','4440'),
('2205','2-50-42-600-20250','2-50-42-600-26595','4429'),
('1425','2-50-50-430-20250','2-50-50-430-26595','4436'),
('325','2-30-11-010-21280','2-30-11-010-26550','4423'),
('2350','2-50-42-600-21280','2-50-42-600-26550','4430'),
('1572','2-50-44-810-21280','2-50-44-810-26550','4433'),
('1274','6-60-21-000-66200','6-60-21-210-66200','3862'),
('1779','6-50-46-000-66300','6-50-44-850-66300','3859'),
('2064','6-50-44-000-66100','6-50-44-850-66100','3854'),
('2171','6-50-45-000-66100','6-50-45-750-66100','3856'),
('2684','6-60-21-095-66200','6-60-21-210-66200','3862'),
('2922','6-50-44-000-69000','6-50-44-850-69000','3855'),
('3430','2-30-16-120-25499','2-50-42-649-25499','3657'),
('3431','2-30-16-120-25999','2-50-42-649-25999','3684');

-- BEGIN TRANSACTION TEST

-- UPDATE GL CHANGER ACCOUNTS FOR DR ACCOUNT ON MAIN RECORD
UPDATE P SET
	dACCTINDEXDR = F.NEWACTINDX
FROM
PJ30102 P
INNER JOIN ACTFIX2021 F ON P.dACCTINDEXDR = F.OLDACTINDX

-- UPDATE GL CHANGER ACCOUNTS FOR CR ACCOUNT ON MAIN RECORD
UPDATE P SET
	dACCTINDEXCR = F.NEWACTINDX
FROM
PJ30102 P
INNER JOIN ACTFIX2021 F ON P.dACCTINDEXCR = F.OLDACTINDX

-- UPDATE GL CHANGER ACCOUNTS FOR OVERHEAD ACCOUNT ON MAIN RECORD
UPDATE P SET
	dACCTINDEXOH = F.NEWACTINDX
FROM
PJ30102 P
INNER JOIN ACTFIX2021 F ON P.dACCTINDEXOH = F.OLDACTINDX

-- UPDATE Project Costing Distribution Table
-- Below two updates will MERGE to OLD accounts into one NEW account
-- First Query will update the first old account index for new account and add two old distributions together
UPDATE A
SET
	dTRXAMOUNT=dTRXAMOUNT+(SELECT dTRXAMOUNT FROM PJ30103 Z WHERE Z.dDOCSUFFIX = A.dDOCSUFFIX AND Z.dACCTINDEX = 2684)
FROM
PJ30103 A WHERE A.dDOCSUFFIX IN (
SELECT
	P.dDOCSUFFIX
FROM
PJ30103 P
INNER JOIN ACTFIX2021 F ON P.dACCTINDEX = F.OLDACTINDX
WHERE F.NEWACTINDX = 3862
GROUP BY dDOCSUFFIX
HAVING COUNT(F.NEWACTINDX) > 1) 
AND A.dACCTINDEX = 1274

DELETE
FROM
PJ30103
WHERE 
dACCTINDEX = 2684 
AND
dDOCSUFFIX IN (
SELECT
	P.dDOCSUFFIX
FROM
PJ30103 P
INNER JOIN ACTFIX2021 F ON P.dACCTINDEX = F.OLDACTINDX
WHERE F.NEWACTINDX = 3862
GROUP BY dDOCSUFFIX
HAVING COUNT(F.NEWACTINDX) > 1) 

-- With above merge complete we should be able to do a straight one to one mapping below.
UPDATE P SET
	dACCTINDEX = F.NEWACTINDX
FROM
PJ30103 P
INNER JOIN ACTFIX2021 F ON P.dACCTINDEX = F.OLDACTINDX
WHERE dDOCSUFFIX NOT IN (SELECT
	P.dDOCSUFFIX
FROM
PJ30103 P
INNER JOIN ACTFIX2021 F ON P.dACCTINDEX = F.OLDACTINDX
WHERE F.NEWACTINDX = 3862
GROUP BY dDOCSUFFIX
HAVING COUNT(F.NEWACTINDX) > 1)

-- Finally update Asset Costing GL Distributions. This was the only table populated 
-- with an account index to update that we found.
UPDATE P SET
	ACTINDX = F.NEWACTINDX
FROM
PJ30600 P
INNER JOIN ACTFIX2021 F ON P.ACTINDX = F.OLDACTINDX

-- ROLLBACK TRANSACTION TEST